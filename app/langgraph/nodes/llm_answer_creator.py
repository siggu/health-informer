# llm_answer_creator.py (Gemini Version)
# ëª©ì : "Answer LLM" ë…¸ë“œ
# - RetrievalPlannerì˜ ê²°ê³¼ë¥¼ ë°›ì•„ ìµœì¢… ë‹µë³€ ìƒì„±
# - Google Gemini APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹µë³€ ìƒì„±

from __future__ import annotations

import json
import os
from datetime import datetime, timezone
from typing import Any, Dict, List, Optional

from dotenv import load_dotenv
import google.generativeai as genai

from app.langgraph.state.ephemeral_context import State as GraphState, Message

load_dotenv()

# Gemini API ì„¤ì •
genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
ANSWER_MODEL = os.getenv("ANSWER_MODEL", "gemini-2.0-flash")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SYSTEM_PROMPT = """
# ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” RetrievalPlannerë¡œë¶€í„° ì „ë‹¬ëœ ë¬¸ì„œ ëª©ë¡ë§Œì„ ì‚¬ìš©í•˜ì—¬ ë‹µë³€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
# ê·œì¹™:
# - ì „ë‹¬ëœ ë¬¸ì„œë“¤ë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.
# - ì „ë‹¬ë˜ì§€ ì•Šì€ ë¬¸ì„œëŠ” ìƒì„±í•˜ê±°ë‚˜ ê°€ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
# - ì „ë‹¬ëœ ë¬¸ì„œê°€ 6ê°œë©´ 6ê°œ ëª¨ë‘ ì¶œë ¥í•˜ê³ ,
#   ì „ë‹¬ëœ ë¬¸ì„œê°€ 1ê°œë©´ 1ê°œë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.
# - ì‚¬ìš©ìê°€ ìê²©ì´ ë˜ëŠ” ì§€ì›ì‚¬ì—…ë§Œ ì´ë¯¸ í•„í„°ë§ëœ ìƒíƒœë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
# - ë‹¹ì‹ ì€ ì¶”ê°€ì ì¸ ìê²© íŒë‹¨ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
# - ë¬¸ì„œì— ìˆëŠ” ìš”ê±´ ë° ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ìš”ì•½í•˜ì—¬ ì•ˆë‚´í•©ë‹ˆë‹¤.
# - ë‹µë³€ ë§ˆì§€ë§‰ì— ì¶œì²˜ URLì„ í¬í•¨í•©ë‹ˆë‹¤.
# """

# SYSTEM_PROMPT = """
# ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” RetrievalPlannerë¡œë¶€í„° ì „ë‹¬ëœ ë¬¸ì„œ ëª©ë¡ë§Œì„ ì‚¬ìš©í•˜ì—¬ ë‹µë³€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

# ê·œì¹™(ì ˆëŒ€ ì¤€ìˆ˜):
# - ì „ë‹¬ëœ ë¬¸ì„œë“¤ë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.
# - ì „ë‹¬ë˜ì§€ ì•Šì€ ë¬¸ì„œëŠ” ìƒì„±í•˜ê±°ë‚˜ ì¶”ë¡ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
# - ì „ë‹¬ëœ document ê°œìˆ˜ë§Œí¼ ì •í™•íˆ ê°™ì€ ê°œìˆ˜ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
# - ì´ë¯¸ RetrievalPlannerì—ì„œ ìê²© í•„í„°ë§ì´ ì™„ë£Œëœ ìƒíƒœì´ë¯€ë¡œ ì¶”ê°€ ìê²© íŒë‹¨ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

# ì¶œë ¥ í˜•ì‹(ê°•ì œ):
# ê° ë¬¸ì„œëŠ” ì•„ë˜ í˜•ì‹ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ ì¶œë ¥í•©ë‹ˆë‹¤:

# {ë¬¸ì„œë²ˆí˜¸}. {title}
# - ì§€ì› ë‚´ìš©: ë¬¸ì„œì˜ "benefits" ë˜ëŠ” snippet ê¸°ë°˜ìœ¼ë¡œ ìš”ì•½
# - ì§€ì› ìê²©: ë¬¸ì„œì˜ "requirements" ê¸°ë°˜ìœ¼ë¡œ ìš”ì•½
# - ì‹ ì²­ ë°©ë²•: ë¬¸ì„œì— ì¡´ì¬í•˜ë©´ ìš”ì•½, ì—†ìœ¼ë©´ ë§í¬ ì°¸ì¡°
# - ë§í¬: {url}

# ì£¼ì˜:
# - ë§í¬ëŠ” ê° ë¬¸ì„œë§ˆë‹¤ ë”± í•œ ë²ˆë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.
# - ë§ˆì§€ë§‰ì— ì „ì²´ URL ëª©ë¡ì„ ë‹¤ì‹œ ë‚˜ì—´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
# - ì§€ì› ë‚´ìš©/ìê²©/ì‹ ì²­ë°©ë²•ì´ ë¬¸ì„œì— ì—†ìœ¼ë©´ "ì œê³µëœ ë¬¸ì„œì— í•´ë‹¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."ë¼ê³  ëª…ì‹œí•©ë‹ˆë‹¤.
# - ë¬¸ì„œ ìˆœì„œëŠ” ì „ë‹¬ë°›ì€ ìˆœì„œë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.

# ë‹µë³€ ì „ì²´ êµ¬ì¡°:
# 1) ê°„ë‹¨í•œ í•œ ì¤„ ê²°ë¡ 
# 2) ìœ„ ì¶œë ¥ í˜•ì‹ì— ë”°ë¼ ë¬¸ì„œë“¤ì„ ë‚˜ì—´
# 3) ì¶”ê°€ ì•ˆë‚´(í•„ìš”í•œ ê²½ìš°ë§Œ)
# """
SYSTEM_PROMPT = """
ë‹¹ì‹ ì€ ì˜ë£ŒÂ·ë³µì§€ ì§€ì›ìê²© ìƒë‹´ì‚¬ì´ì, ì •ì±… í›„ë³´ë“¤ì„ ì¬ì •ë ¬(rerank)í•˜ëŠ” ì „ë¬¸ê°€ì´ë‹¤.

ì…ë ¥ìœ¼ë¡œ ë‹¤ìŒ ì •ë³´ê°€ ì£¼ì–´ì§„ë‹¤:
- ì‚¬ìš©ì ì§ˆë¬¸
- Profile ì»¨í…ìŠ¤íŠ¸: ë‚˜ì´/ê±°ì£¼ì§€/ì†Œë“ìˆ˜ì¤€(ì¤‘ìœ„ì†Œë“ ë¹„ìœ¨)/ê¸°ì´ˆìƒí™œë³´ì¥ ê¸‰ì—¬/ì¥ì• ë“±ê¸‰/ì¥ê¸°ìš”ì–‘ë“±ê¸‰/ì„ì‹ Â·ì¶œì‚° ì—¬ë¶€ ë“±
- Collection ì»¨í…ìŠ¤íŠ¸: ì‚¬ìš©ìì˜ êµ¬ì²´ì ì¸ ì§ˆí™˜Â·ì¹˜ë£ŒÂ·ì…ì›Â·ìˆ˜ìˆ Â·ê²€ì‚¬Â·ì—í”¼ì†Œë“œ(íŠ¸ë¦¬í”Œ í˜•íƒœ)
- RAG ë¬¸ì„œ ìŠ¤ë‹ˆí«: ë²ˆí˜¸ê°€ ë¶™ì€ í›„ë³´ ì •ì±… ëª©ë¡(ê°ê° ì œëª©, ì§€ì—­, ìš”ì•½/ë°œì·Œ í…ìŠ¤íŠ¸ í¬í•¨)

ë‹¹ì‹ ì˜ ì—­í• ì€ ë‹¤ìŒ ë‘ ê°€ì§€ë¥¼ **ëª¨ë‘** ìˆ˜í–‰í•˜ëŠ” ê²ƒì´ë‹¤:
1) ì£¼ì–´ì§„ í›„ë³´ ì •ì±…ë“¤ ì¤‘ì—ì„œ **ì‚¬ìš©ìì—ê²Œ ê°€ì¥ ì˜ ë§ëŠ” ì •ì±…ì„ ë‚´ë¶€ì ìœ¼ë¡œ ì„ ë³„Â·ì¬ì •ë ¬(rerank)** í•œë‹¤.
2) ì„ ë³„ëœ ì •ì±…ë“¤ì„ ê·¼ê±°ë¡œ, **ëª…í™•í•˜ê³  ì¹œì ˆí•œ í•œêµ­ì–´ ë‹µë³€**ì„ ìƒì„±í•œë‹¤.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[ì •ì±… í›„ë³´ ì„ ë³„Â·ì¬ì •ë ¬ ê·œì¹™(ë‚´ë¶€ ë‹¨ê³„)]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ë‹¤ìŒ ì ˆì°¨ë¥¼ **ë¨¸ë¦¿ì†ì—ì„œ ìˆœì„œëŒ€ë¡œ ìˆ˜í–‰í•˜ë¼. ì ìˆ˜/ì¤‘ê°„ íŒë‹¨ì€ ë‹µë³€ì— êµ³ì´ ë…¸ì¶œí•  í•„ìš”ëŠ” ì—†ë‹¤.**

1. ì‚¬ìš©ì ìƒíƒœ ì •ë¦¬
   - Profile/Collection ì»¨í…ìŠ¤íŠ¸ë¥¼ ì½ê³ , ë‹¤ìŒ ì •ë³´ë¥¼ ë¨¸ë¦¿ì†ì— ì •ë¦¬í•œë‹¤.
     - ê±°ì£¼ ì§€ì—­(ì‹œÂ·êµ°Â·êµ¬) ë° ì§€ì—­ ë‹¨ìœ„(ì „êµ­/ê´‘ì—­ì‹œ/êµ¬ ë‹¨ìœ„ ë“±)
     - ê¸°ì¤€ì¤‘ìœ„ì†Œë“ ë¹„ìœ¨(ì˜ˆ: 50%, 80%, 120% ë“±)
     - ê¸°ì´ˆìƒí™œë³´ì¥ ê¸‰ì—¬(ìƒê³„/ì˜ë£Œ/ì£¼ê±°/êµìœ¡/ì°¨ìƒìœ„ ì—¬ë¶€ ë“±)
     - ì¥ì• ë“±ê¸‰(0: ì—†ìŒ, 1: ì‹¬í•˜ì§€ ì•ŠìŒ, 2: ì‹¬í•¨)
     - ì¥ê¸°ìš”ì–‘ë“±ê¸‰(1~5ë“±ê¸‰, ë˜ëŠ” ì—†ìŒ)
     - ì„ì‹ /ì¶œì‚° 12ê°œì›” ì´ë‚´ ì—¬ë¶€
     - Collectionì— ê¸°ë¡ëœ êµ¬ì²´ì ì¸ ì§ˆí™˜Â·ìƒíƒœ(ì˜ˆ: ë‹¹ë‡¨ë³‘, ì•”, í¬ê·€ì§ˆí™˜, íˆ¬ì„, í•­ì•”ì¹˜ë£Œ, ìµœê·¼ 6ê°œì›” ì§„ë‹¨ ë“±)

2. ê° í›„ë³´ ì •ì±…ì— ëŒ€í•´ **ë‚´ë¶€ì ìœ¼ë¡œ** ë‹¤ìŒì„ í‰ê°€í•˜ë¼.
   - ê·¸ ì •ì±…ì˜ ì§€ì› ëŒ€ìƒ/ìê²©ìš”ê±´ì´ ë¬´ì—‡ì¸ì§€ íŒŒì•…í•œë‹¤.
     - ì†Œë“ ê¸°ì¤€(ì¤‘ìœ„ì†Œë“ XX% ì´í•˜/ì´ìƒ/ë²”ìœ„)
     - ì§ˆí™˜/ìƒíƒœ ê¸°ì¤€(ì˜ˆ: ì•”, í¬ê·€ì§ˆí™˜, ë‹¹ë‡¨, ì„ì‚°ë¶€, ë…¸ì¸, ì¥ì• ì¸ ë“±)
     - ì¥ì• /ì¥ê¸°ìš”ì–‘ ë“±ê¸‰ ê¸°ì¤€
     - ê¸°ì´ˆìƒí™œë³´ì¥Â·ì°¨ìƒìœ„Â·ì˜ë£Œê¸‰ì—¬ ìˆ˜ê¸‰ì ì—¬ë¶€
     - ì—°ë ¹Â·ì„¸ëŒ€(ì²­ë…„/ì•„ë™/ì–´ë¥´ì‹ /í•™ìƒ/ê³ 3/ëŒ€í•™ìƒ ë“±)
     - ì§€ì—­ ê¸°ì¤€(ì „êµ­, ì‹œ, êµ¬ ë“±)
   - ì‚¬ìš©ìì˜ Profile/Collectionê³¼ ë¹„êµí•˜ì—¬,
     - ìê²©ìš”ê±´ì„ ëª…í™•íˆ ì¶©ì¡±í•˜ëŠ”ì§€
     - ëª¨í˜¸í•˜ì§€ë§Œ ê°€ëŠ¥ì„±ì´ ìˆëŠ”ì§€
     - ê±°ì˜ ë§ì§€ ì•ŠëŠ”ì§€
   - ë¨¸ë¦¿ì†ì—ì„œ **0~100ì  ì‚¬ì´ì˜ â€œì í•©ë„ ì ìˆ˜(eligibility_score)â€**ë¥¼ ë§¤ê¸°ê³ ,
     - 0~30: ì¡°ê±´ì´ ê±°ì˜ ë§ì§€ ì•ŠìŒ (ë‹¤ë¥¸ ê³„ì¸µ/ì§ˆí™˜/ì†Œë“êµ¬ê°„ ëŒ€ìƒìœ¼ë¡œ ë³´ì„)
     - 31~60: ì¼ë¶€ ì¡°ê±´ì€ ë§ì§€ë§Œ, í•µì‹¬ ê¸°ì¤€ì´ ë¶ˆëª…í™•í•˜ê±°ë‚˜ ë¶€ì¡±í•¨
     - 61~85: ëŒ€ì²´ë¡œ ì˜ ë§ì§€ë§Œ, ì•½ê°„ì˜ ë¶ˆí™•ì‹¤ì„± ë˜ëŠ” ëˆ„ë½ëœ ì •ë³´ê°€ ìˆìŒ
     - 86~100: ì‚¬ìš©ìì˜ ìƒíƒœì™€ ë§¤ìš° ì˜ ë¶€í•©í•¨ (í•µì‹¬ ìê²©ìš”ê±´ì´ ëšœë ·í•˜ê²Œ ì¼ì¹˜)

3. **êµ¬ì²´ ì¡°ê±´ ìš°ì„  ê·œì¹™**
   ë‹¤ìŒ ì¡°ê±´ì„ ê°€ì§„ í›„ë³´ ì •ì±…ì€ ë†’ì€ ì ìˆ˜ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ë¶€ì—¬í•˜ë¼.
   - Collectionì— ê¸°ë¡ëœ **êµ¬ì²´ ì§ˆí™˜/ìƒíƒœ**ê°€ ì •ì±… ìš”ê±´ì— ëª…ì‹œì ìœ¼ë¡œ ë“±ì¥í•˜ëŠ” ê²½ìš°
     - ì˜ˆ: ì‚¬ìš©ìê°€ â€œë‹¹ë‡¨ë³‘â€ì´ê³  ì •ì±… ìš”ê±´ì— â€œë‹¹ë‡¨Â·ê³ í˜ˆì•• ë“± ë§Œì„±ì§ˆí™˜ìâ€ê°€ í¬í•¨
     - ì˜ˆ: ì‚¬ìš©ìê°€ â€œìœ ë°©ì•” ì§„ë‹¨ í›„ í•­ì•”ì¹˜ë£Œ ì¤‘â€ì´ê³  ì •ì±…ì´ â€œì•” í™˜ì ì˜ë£Œë¹„ ì§€ì›â€
     - ì˜ˆ: ì‚¬ìš©ìê°€ â€œí¬ê·€ì§ˆí™˜ ì‚°ì •íŠ¹ë¡€ ë“±ë¡ìâ€ì´ê³  ì •ì±…ì´ â€œí¬ê·€Â·ë‚œì¹˜ì„± ì§ˆí™˜ìâ€
   - Profileì˜ **ì¤‘ìœ„ì†Œë“ ë¹„ìœ¨Â·ê¸°ì´ˆìƒí™œë³´ì¥Â·ì¥ì• /ì¥ê¸°ìš”ì–‘ ë“±ê¸‰**ì´
     ì •ì±…ì˜ ìˆ˜ì¹˜ ì¡°ê±´Â·ë“±ê¸‰ ì¡°ê±´ê³¼ ëª…í™•íˆ í˜¸í™˜ë˜ëŠ” ê²½ìš°
   - íŠ¹ì • ì—°ë ¹/ì„¸ëŒ€(ì²­ë…„, ì•„ë™, ê³ ë ¹ì, ì„ì‚°ë¶€ ë“±)ì´ ì •ì±… ëŒ€ìƒì— ëª…ì‹œë˜ê³ ,
     ì‚¬ìš©ìì˜ ë‚˜ì´/ìƒíƒœì™€ ì¼ì¹˜í•˜ëŠ” ê²½ìš°

4. **ëª…ë°±í•œ ë¶ˆì¼ì¹˜ ì •ì±…ì€ ì›ì¹™ì ìœ¼ë¡œ ì œì™¸**
   ì•„ë˜ì™€ ê°™ì´ ìê²©ìš”ê±´ê³¼ í¬ê²Œ ì–´ê¸‹ë‚˜ëŠ” ì •ì±…ì€, ì›ì¹™ì ìœ¼ë¡œ â€œì¶”ì²œÂ·ê·¼ê±°â€ë¡œ ì‚¬ìš©í•˜ì§€ ë§ë¼.
   - â€œì¥ê¸°ìš”ì–‘ 1~2ë“±ê¸‰â€ ëŒ€ìƒì¸ë°, ì‚¬ìš©ìëŠ” ì¥ê¸°ìš”ì–‘ë“±ê¸‰ ì •ë³´ê°€ ì—†ê±°ë‚˜ 3ë“±ê¸‰ ì´ìƒì¸ ê²½ìš°
   - â€œì•” í™˜ì ì§€ì›â€ ì •ì±…ì¸ë°, ì‚¬ìš©ì ì§ˆí™˜ ì •ë³´ì— ì•”/ì¢…ì–‘ ê´€ë ¨ ë‚´ìš©ì´ ì „í˜€ ì—†ëŠ” ê²½ìš°
   - â€œí¬ê·€ì§ˆí™˜ ì‚°ì •íŠ¹ë¡€ ë“±ë¡ìâ€ ëŒ€ìƒì¸ë°, í¬ê·€ì§ˆí™˜/ì‚°ì •íŠ¹ë¡€ ì—¬ë¶€ì— ëŒ€í•œ ë‹¨ì„œê°€ ì „í˜€ ì—†ëŠ” ê²½ìš°
   - â€œê¸°ì´ˆìƒí™œë³´ì¥Â·ì°¨ìƒìœ„ ìˆ˜ê¸‰ìâ€ë§Œ ëŒ€ìƒì¸ë°, ì‚¬ìš©ìê°€ ì¤‘ìœ„ì†Œë“ì´ ë§¤ìš° ë†’ê³  ìˆ˜ê¸‰ì ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°
   ë‹¤ë§Œ, ì‚¬ìš©ìê°€ â€œì „ë°˜ì ìœ¼ë¡œ ì–´ë–¤ ì œë„ê°€ ìˆëŠ”ì§€ ì•Œê³  ì‹¶ë‹¤â€ëŠ” ì·¨ì§€ë¼ë©´
   ì •ë³´ ì œê³µ ëª©ì ìœ¼ë¡œ ì†Œê°œí•  ìˆ˜ ìˆìœ¼ë‚˜, ê·¸ ê²½ìš° ë°˜ë“œì‹œ **ìê²©ì´ í™•ì‹¤í•˜ì§€ ì•Šë‹¤ëŠ” ì **ì„ ë¶„ëª…íˆ ë°í˜€ë¼.

5. ìµœì¢… ì„ íƒ
   - ë‚´ë¶€ì ìœ¼ë¡œ ì í•©ë„ ì ìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ **ìƒìœ„ 3~5ê°œ ì •ì±…ë§Œ ìµœì¢… ê·¼ê±°ë¡œ ì‚¬ìš©í•˜ë¼.**
   - ë‹µë³€ì—ì„œ ìƒì„¸íˆ ì„¤ëª…í•˜ëŠ” ì •ì±…ì€ ì´ ìƒìœ„ ì •ì±…ë“¤ë¡œ ì œí•œí•˜ë¼.
   - ë‚˜ë¨¸ì§€ í›„ë³´ ì •ì±…ë“¤ì€ í•„ìš”í•  ë•Œ â€œì¶”ê°€ë¡œ ê²€í† í•  ìˆ˜ ìˆëŠ” ì •ì±…â€ ì •ë„ë¡œ ì§§ê²Œ ì–¸ê¸‰í•˜ê±°ë‚˜, ì•„ì˜ˆ ì–¸ê¸‰í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[ë‹µë³€ ìƒì„± ê·œì¹™]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. ì „ì²´ êµ¬ì¡°
   - ë§¨ ì•ì— **êµµê²Œ í•œ ì¤„ ê²°ë¡ **ìœ¼ë¡œ ìš”ì•½:
     - ì˜ˆ: "**í˜„ì¬ ì •ë³´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³¼ ë•Œ, OO ì§€ì›ì‚¬ì—… 2~3ê°œ ì •ë„ë¥¼ ì‹ ì²­í•´ ë³¼ ìˆ˜ ìˆëŠ” ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.**"
     ### [ì •ì±… ì¶œë ¥ í¬ë§· ê·œì¹™]
     ê° ì •ì±…ì€ ë°˜ë“œì‹œ ë‹¤ìŒ êµ¬ì¡°ë¡œ ë¬¶ì–´ì„œ ì¶œë ¥í•œë‹¤:
   - ì´í›„ 2~4ê°œì˜ ì„¹ì…˜ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ì„¤ëª…:
     1) **ì¶”ì²œ ì •ì±… ìš”ì•½**
     2) **ìê²© ì í•©ì„± ê·¼ê±°** (ì‚¬ìš©ì ì •ë³´ì™€ ì •ì±… ì¡°ê±´ ë¹„êµ)
     3) **ì‹ ì²­ ë°©ë²• ë° ë‹¤ìŒ ë‹¨ê³„**
     4) **ì •ì±… URL**
     - URLì€ ê° ì •ì±… ë¸”ë¡ì—ì„œ í•œ ë²ˆë§Œ ì¶œë ¥
     - ë™ì¼ URL ë°˜ë³µ ê¸ˆì§€
     5) (ì„ íƒ) ê¸°íƒ€ ì°¸ê³ ì‚¬í•­Â·ì£¼ì˜ì‚¬í•­


2. ì¶”ì²œ ì •ì±… ìš”ì•½
   - ê° ì •ì±…ë§ˆë‹¤ ë‹¤ìŒ ì •ë³´ë¥¼ ê°„ê²°í•˜ê²Œ ì •ë¦¬:
     - ì •ì±…ëª… + (ì§€ì—­/ê¸°ê´€)
     - ì–´ë–¤ ì‚¬ëŒì„ ìœ„í•œ ì •ì±…ì¸ì§€(íƒ€ê¹ƒ ê³„ì¸µ/ì§ˆí™˜/ì†Œë“ ë“±)
     - ì‚¬ìš©ì í”„ë¡œí•„Â·ì»¬ë ‰ì…˜ê³¼ì˜ êµ¬ì²´ì ì¸ ì¼ì¹˜ í¬ì¸íŠ¸
       (ì˜ˆ: "ì˜ë£Œê¸‰ì—¬ 2ì¢… + ì•” ì¹˜ë£Œ ì¤‘ì´ë¯€ë¡œ, í•´ë‹¹ ì¡°ê±´ì— ì •í™•íˆ ë¶€í•©í•©ë‹ˆë‹¤.")
   - ì í•©ë„ê°€ ë†’ì€ ì •ì±…ë¶€í„° ìˆœì„œëŒ€ë¡œ ë‚˜ì—´í•˜ë¼.

3. ìê²© ì í•©ì„± ê·¼ê±°
   - Profile/Collectionê³¼ ì •ì±… ìš”ê±´ì„ ì§ì ‘ ë¹„êµí•´ ì„¤ëª…:
     - ì†Œë“: â€œì‚¬ìš©ì ì¤‘ìœ„ì†Œë“ ì•½ 50% â†’ ì •ì±… ìš”ê±´ â€˜ì¤‘ìœ„ì†Œë“ 80% ì´í•˜â€™ì— ì¶©ë¶„íˆ í•´ë‹¹â€
     - ì§ˆí™˜: â€œìœ ë°©ì•”(C50.x) ì§„ë‹¨ ë° í•­ì•” ì¹˜ë£Œ ì¤‘ â†’ ì•” í™˜ì ëŒ€ìƒ ì •ì±…ê³¼ ì¼ì¹˜â€
     - ì¥ì• /ì¥ê¸°ìš”ì–‘ ë“±ê¸‰: â€œì¥ì•  2ë“±ê¸‰ â†’ â€˜ì¤‘ì¦ ì¥ì• ì¸â€™ ì¡°ê±´ ì¶©ì¡±â€ ë“±
     - ì§€ì—­: â€œì„œìš¸ ë™ì‘êµ¬ ê±°ì£¼ â†’ ì„œìš¸ì‹œ/ë™ì‘êµ¬ ì •ì±…ì— í•´ë‹¹â€
   - ì¡°ê±´ì´ ëª¨í˜¸í•˜ê±°ë‚˜ ì •ë³´ê°€ ë¶€ì¡±í•œ ê²½ìš°:
     - â€œí˜„ì¬ ì •ë³´ë¡œëŠ” ìê²© ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë‚˜, ì‹¤ì œ ì‹ ì²­ ì‹œ ì¶”ê°€ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.â€ì²˜ëŸ¼ í‘œí˜„í•˜ë¼.
   - ëª…ë°±íˆ ì¡°ê±´ì´ ë§ì§€ ì•ŠëŠ” ì •ì±…ì— ëŒ€í•´ì„œëŠ”:
     - â€œìš”ê±´ìƒ í˜„ì¬ ì •ë³´ë¡œëŠ” ëŒ€ìƒì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.â€ë¼ê³  ë¶„ëª…íˆ ì„¤ëª…í•˜ë¼.

4. ì‹ ì²­ ë°©ë²• ë° ë‹¤ìŒ ë‹¨ê³„
   - ê° ì •ì±…ë³„ë¡œ:
     - ë‹´ë‹¹ ê¸°ê´€(ì˜ˆ: êµ­ë¯¼ê±´ê°•ë³´í—˜ê³µë‹¨, êµ¬ì²­ ë³µì§€ê³¼ ë“±)
     - ëŒ€í‘œì ì¸ ì‹ ì²­ ì±„ë„(ë°©ë¬¸, ì „í™”, ì˜¨ë¼ì¸ ë“±)
     - ê¸°ë³¸ì ì¸ ì¤€ë¹„ì„œë¥˜ ìœ í˜•(ì§„ë‹¨ì„œ, ì‚°ì •íŠ¹ë¡€ ë“±ë¡ì¦, ê±´ê°•ë³´í—˜ ìê²©ë“ì‹¤ í™•ì¸ì„œ ë“±)
   - êµ¬ì²´ì ì¸ ì„œë¥˜ëª…Â·ì£¼ì†ŒÂ·ì „í™”ë²ˆí˜¸Â·URLì€ **ì œê³µëœ ë¬¸ì„œì— ìˆì„ ë•Œë§Œ** ì‚¬ìš©í•˜ê³ ,
     ì—†ìœ¼ë©´ â€œëŒ€í‘œì ì¸ ì˜ˆì‹œâ€ ìˆ˜ì¤€ìœ¼ë¡œë§Œ ì•ˆë‚´í•˜ë¼.
   - â€œì •í™•í•œ ìê²© ì—¬ë¶€ëŠ” ê´€í•  ê¸°ê´€ì—ì„œ ìµœì¢… í™•ì¸í•´ì•¼ í•œë‹¤â€ëŠ” ì ì„ ëª…ì‹œí•´ë¼.

5. í›„ë³´ ì •ì±…ì´ í•˜ë‚˜ë„ ì˜ ë§ì§€ ì•ŠëŠ” ê²½ìš°
   - â€œí˜„ì¬ ê²€ìƒ‰ëœ ì •ì±…ë“¤ ì¤‘ì—ì„œëŠ”, ì‚¬ìš©ìì˜ ì§ˆí™˜/ì†Œë“/ë“±ê¸‰ ì¡°ê±´ì— ë”± ë§ëŠ” ì§€ì›ì‚¬ì—…ì„ ì°¾ê¸° ì–´ë µìŠµë‹ˆë‹¤.â€ë¼ê³  ì†”ì§íˆ ë§í•˜ë¼.
   - ê·¸ ëŒ€ì‹ :
     - ì¼ë°˜ì ì¸ ì˜ë£Œë¹„ ê²½ê° ì œë„(ë³¸ì¸ë¶€ë‹´ ìƒí•œì œ, ì¬ë‚œì  ì˜ë£Œë¹„, ì‚°ì •íŠ¹ë¡€ ë“±)ë¥¼ ì†Œê°œí•˜ê±°ë‚˜,
     - êµ­ë¯¼ê±´ê°•ë³´í—˜ê³µë‹¨/ì§€ìì²´ ë³µì§€ ìƒë‹´ ì°½êµ¬ì— ì¶”ê°€ ë¬¸ì˜í•˜ë„ë¡ ì•ˆë‚´í•˜ë¼.
   - ë§Œì•½ ì‚¬ìš©ìê°€ íŠ¹ì • ì§ˆí™˜(ì˜ˆ: ì•”) ì§€ì›ì„ ë¬¼ì—ˆëŠ”ë°,
     - ì œê³µ ë¬¸ì„œì— ì•” ì§€ì› ê´€ë ¨ ì •ì±…ì´ ì—†ë‹¤ë©´, ì•” ì§€ì› ì •ì±…ì´ ì—†ë‹¤ê³  ë‹¨ì •í•˜ì§€ ë§ê³ ,
       â€œì´ë²ˆ ê²€ìƒ‰ ê²°ê³¼ì—ì„œëŠ” ì•” ì§€ì›ì„ ëª…ì‹œí•œ ì •ì±…ì„ ì°¾ì§€ ëª»í–ˆë‹¤â€ê³  ì„¤ëª…í•˜ë¼.

6. ìŠ¤íƒ€ì¼/ë³´ì•ˆ ê·œì¹™
   - ì „ì²´ ë‹µë³€ì€ **í•œêµ­ì–´**ë¡œ ì‘ì„±í•œë‹¤.
   - ë§ˆí¬ë‹¤ìš´(ì†Œì œëª©, êµµì€ ê¸€ì”¨, ë¦¬ìŠ¤íŠ¸)ì„ ì‚¬ìš©í•´ ê°€ë…ì„±ì„ ë†’ì¸ë‹¤.
   - ë‹¨ì •í•˜ê¸° ì–´ë ¤ìš´ ë¶€ë¶„ì€ â€œê°€ëŠ¥ì„±ì´ ìˆë‹¤/ì¶”ê°€ í™•ì¸ í•„ìš”í•˜ë‹¤â€ ì‹ìœ¼ë¡œ ì„œìˆ í•˜ë¼.
   - ì œê³µëœ ì»¨í…ìŠ¤íŠ¸(Profile/Collection/ë¬¸ì„œ) ë°–ì˜ ì‚¬ì‹¤ì„ **ì¶”ì¸¡í•´ì„œ ë§Œë“¤ì–´ë‚´ì§€ ë§ë¼.**
   - ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸, ì •í™•í•œ ì£¼ì†Œ ë“± ë¯¼ê°í•œ ê°œì¸ì •ë³´ë¥¼ **ì ˆëŒ€ ìš”êµ¬í•˜ì§€ ë§ë¼.**
   - ë‹µë³€ ë§ˆì§€ë§‰ì—, ì‹¤ì œë¡œ ì°¸ê³ í•œ ì •ì±…ë“¤ì˜ **ì œëª©ê³¼ URL**ì„ ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ì •ë¦¬í•˜ë¼.

"""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì»¨í…ìŠ¤íŠ¸ ìš”ì•½/ì„œì‹í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def _format_profile_ctx(p: Optional[Dict[str, Any]]) -> str:
    if not p or "error" in p:
        return ""
    lines: List[str] = []

    if p.get("summary"):
        lines.append(f"- ìš”ì•½: {p['summary']}")

    if p.get("insurance_type"):
        lines.append(f"- ê±´ë³´ ìê²©: {p['insurance_type']}")

    mir_raw = p.get("median_income_ratio")
    if mir_raw is not None:
        try:
            v = float(mir_raw)
            if v <= 10:
                pct = v * 100.0
            else:
                pct = v
            lines.append(f"- ì¤‘ìœ„ì†Œë“ ë¹„ìœ¨: {pct:.1f}%")
        except:
            lines.append(f"- ì¤‘ìœ„ì†Œë“ ë¹„ìœ¨: {mir_raw}")

    if (bb := p.get("basic_benefit_type")):
        lines.append(f"- ê¸°ì´ˆìƒí™œë³´ì¥: {bb}")

    if (dg := p.get("disability_grade")) is not None:
        dg_label = {0: "ë¯¸ë“±ë¡", 1: "ì‹¬í•œ", 2: "ì‹¬í•˜ì§€ì•ŠìŒ"}.get(dg, str(dg))
        lines.append(f"- ì¥ì•  ë“±ê¸‰: {dg_label}")

    if (lt := p.get("ltci_grade")) and lt != "NONE":
        lines.append(f"- ì¥ê¸°ìš”ì–‘ ë“±ê¸‰: {lt}")

    if p.get("pregnant_or_postpartum12m") is True:
        lines.append("- ì„ì‹ /ì¶œì‚° 12ê°œì›” ì´ë‚´")

    return "\n".join(lines)


def _format_collection_ctx(items: Optional[List[Dict[str, Any]]]) -> str:
    if not items:
        return ""
    out = []
    for it in items[:8]:
        if "error" in it:
            continue
        segs = []
        if it.get("predicate"):
            segs.append(f"[{it['predicate']}]")
        if it.get("object"):
            segs.append(it["object"])
        out.append("- " + " ".join(segs))
    return "\n".join(out)


def _format_documents(items: Optional[List[Dict[str, Any]]]) -> str:
    if not items:
        return ""
    out: List[str] = []

    for idx, doc in enumerate(items[:6], start=1):
        if not isinstance(doc, dict):
            continue

        title = doc.get("title") or doc.get("doc_id") or f"ë¬¸ì„œ {idx}"
        source = doc.get("source")
        score = doc.get("score")
        url = doc.get("url")
        snippet = doc.get("snippet") or ""

        header = f"{idx}. {title}"
        if source:
            header += f" ({source})"
        if score:
            header += f" [score={score:.3f}]"

        out.append(f"- {header}")
        out.append(f"  > {snippet.strip()}")

        if url:
            out.append(f"  ì¶œì²˜: {url}")

    return "\n".join(out)


def _build_user_prompt(
    input_text: str,
    used: str,
    profile_ctx: Optional[Dict[str, Any]],
    collection_ctx: Optional[List[Dict[str, Any]]],
    summary: Optional[str] = None,
    documents: Optional[List[Dict[str, Any]]] = None,
) -> str:
    prof_block = _format_profile_ctx(profile_ctx)
    coll_block = _format_collection_ctx(collection_ctx)
    doc_block = _format_documents(documents)
    summary_block = (summary or "").strip()

    lines = [f"ì‚¬ìš©ì ì§ˆë¬¸:\n{input_text.strip()}"]
    lines.append(f"\n[Retrieval ì‚¬ìš©: {used}]")

    if prof_block:
        lines.append("\n[Profile ì»¨í…ìŠ¤íŠ¸]\n" + prof_block)
    if coll_block:
        lines.append("\n[Collection ì»¨í…ìŠ¤íŠ¸]\n" + coll_block)
    if summary_block:
        lines.append("\n[Rolling Summary]\n" + summary_block)
    if doc_block:
        lines.append("\n[RAG ë¬¸ì„œ ìŠ¤ë‹ˆí«]\n" + doc_block)

    lines.append("""
ìš”êµ¬ ì¶œë ¥:
- ë§¨ ì•ì— **ê²°ë¡  í•œ ë¬¸ì¥**
- ë‹¤ìŒì— ê·¼ê±°(ìœ„ ì»¨í…ìŠ¤íŠ¸ì—ì„œë§Œ ì¸ìš©)
- ë§ˆì§€ë§‰ì— ë‹¤ìŒ ë‹¨ê³„(ì¦ë¹™, ì¶”ê°€ í™•ì¸, ì‹ ì²­ ê²½ë¡œ)ë¥¼ ê°„ë‹¨íˆ
- ì¶”ì • ê¸ˆì§€, ì»¨í…ìŠ¤íŠ¸ ë°– ì‚¬ì‹¤ ê¸ˆì§€
""")
    return "\n".join(lines)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Gemini LLM í˜¸ì¶œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def run_answer_llm(
    input_text: str,
    used: str,
    profile_ctx: Optional[Dict[str, Any]],
    collection_ctx: Optional[List[Dict[str, Any]]],
    summary: Optional[str] = None,
    documents: Optional[List[Dict[str, Any]]] = None,
) -> str:

    user_prompt = _build_user_prompt(
        input_text,
        used,
        profile_ctx,
        collection_ctx,
        summary=summary,
        documents=documents,
    )

    model = genai.GenerativeModel(ANSWER_MODEL)

    # Gemini 2.x ì—ì„œëŠ” system role ë¶ˆê°€ëŠ¥ â†’ system í”„ë¡¬í”„íŠ¸ë¥¼ ë¬¸ìì—´ ê²°í•©ìœ¼ë¡œ ë„£ì–´ì•¼ í•¨
    full_prompt = SYSTEM_PROMPT + "\n\n" + user_prompt

    try:
        resp = model.generate_content(
            full_prompt,
            generation_config={"temperature": 0.3},
        )

        # 1) resp.textê°€ ìˆì„ ê²½ìš°
        if hasattr(resp, "text") and resp.text:
            return resp.text.strip()

        # 2) Gemini 2.x í‘œì¤€ êµ¬ì¡°: candidates[].content.parts[].text
        if resp.candidates:
            cand = resp.candidates[0]
            if cand.content and cand.content.parts:
                text = "".join(
                    part.text
                    for part in cand.content.parts
                    if hasattr(part, "text")
                )
                return text.strip()

        return str(resp)

    except Exception as e:
        print("ğŸ”¥ğŸ”¥ [Gemini ERROR]", e)
        raise

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë©”ì‹œì§€ ì»¨í…ìŠ¤íŠ¸ ì¶”ì¶œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def _extract_context_from_messages(messages: List[Message]) -> Dict[str, Any]:
    for msg in reversed(messages or []):
        if msg.get("role") != "tool":
            continue
        if msg.get("content") != "[context_assembler] prompt_ready":
            continue
        meta = msg.get("meta") or {}
        ctx = meta.get("context")
        if isinstance(ctx, dict):
            return ctx
    return {}


def _last_user_content(messages: List[Message]) -> str:
    for msg in reversed(messages or []):
        if msg.get("role") == "user":
            return msg.get("content", "")
    return ""


def _infer_used_flag(profile_ctx: Any, collection_ctx: Any, documents: Any) -> str:
    has_profile = isinstance(profile_ctx, dict) and bool(profile_ctx)
    has_collection = isinstance(collection_ctx, list) and bool(collection_ctx)
    has_docs = isinstance(documents, list) and bool(documents)
    if has_profile and (has_collection or has_docs):
        return "BOTH"
    if has_profile:
        return "PROFILE"
    if has_collection or has_docs:
        return "COLLECTION"
    return "NONE"


def _safe_json(value: Any, limit: int = 400) -> str:
    if not value:
        return "ì—†ìŒ"
    try:
        text = json.dumps(value, ensure_ascii=False)
    except Exception:
        text = str(value)
    return text[:limit] + ("..." if len(text) > limit else "")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Fallback ë©”ì‹œì§€
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def _build_fallback_text(
    used: str,
    profile_ctx: Any,
    collection_ctx: Any,
    documents: Any,
    summary: Optional[str],
) -> str:
    return (
        "ì£„ì†¡í•´ìš”. ì‘ë‹µ ìƒì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.\n\n"
        "## ê·¼ê±°(ìš”ì•½)\n"
        f"- Retrieval ì‚¬ìš©: {used}\n"
        f"- Summary: {(summary or 'ì—†ìŒ')[:400]}\n"
        f"- Profile: {_safe_json(profile_ctx)}\n"
        f"- Collection: {_safe_json(collection_ctx)}\n"
        f"- Documents: {_safe_json(documents)}\n"
        "í•„ìš” ì‹œ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."
    )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë©”ì¸ answer ë…¸ë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def answer(state: GraphState) -> Dict[str, Any]:
    messages: List[Message] = list(state.get("messages") or [])
    retrieval = state.get("retrieval") or {}
    ctx = _extract_context_from_messages(messages)

    profile_ctx = ctx.get("profile") or retrieval.get("profile_ctx")
    collection_ctx = ctx.get("collection") or retrieval.get("collection_ctx")

    if isinstance(collection_ctx, dict) and "triples" in collection_ctx:
        collection_ctx_list = collection_ctx["triples"]
    elif isinstance(collection_ctx, list):
        collection_ctx_list = collection_ctx
    else:
        collection_ctx_list = None

    documents = ctx.get("documents") or retrieval.get("rag_snippets")
    summary = ctx.get("summary") or state.get("rolling_summary")

    input_text = (
        (state.get("user_input") or state.get("input_text") or "").strip()
        or _last_user_content(messages).strip()
    )

    used = (retrieval.get("used") or "").strip().upper()
    if not used:
        used = _infer_used_flag(profile_ctx, collection_ctx_list, documents)

    try:
        text = run_answer_llm(
            input_text,
            used,
            profile_ctx,
            collection_ctx_list,
            summary=summary,
            documents=documents,
        )
    except Exception:
        text = _build_fallback_text(
            used,
            profile_ctx,
            collection_ctx_list,
            documents,
            summary,
        )

    citations = {
        "profile": profile_ctx,
        "collection": collection_ctx_list,
        "documents": documents,
    }

    assistant_message: Message = {
        "role": "assistant",
        "content": text,
        "created_at": datetime.now(timezone.utc).isoformat(),
        "meta": {
            "model": ANSWER_MODEL,
            "used": used,
            "citations": {
                "profile": bool(profile_ctx),
                "collection_count": len(collection_ctx_list or []),
                "document_count": len(documents or []),
            },
        },
    }

    return {
        "answer": {
            "text": text,
            "citations": citations,
            "used": used,
        },
        "messages": [assistant_message],
    }


def answer_llm_node(state: GraphState) -> Dict[str, Any]:
    return answer(state)
